%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                   Testovací aplikace                              %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\n{1}{Testovací aplikace}

Praktická část této práce se zaměřuje na vytvoření testovací aplikace postavené na microservice architektuře. Cílem je vytvořit, otestovat a analyzovat služby využívající JIT a nativní AOT kompilace. Rozsah funkcionality a chování aplikace je definován množinou funkčních a nefunkčních požadavků. Dále jsou vybrány konkrétní technologie a nástroje, jenž v aplikaci doplní .NET služby. Jejich účelem je zprostředkování platformy monitorování, dodání persistence, hostování webového rozhraní a automatizace testování. Samotný postup testování je definován metodikou, která zahrnuje také definici hypotéz a je podrobně popsána v následující kapitole. Tyto hypotézy jsou v analytické sekci práce ověřeny. Ověření probíhá rámci experimentů, které jsou provedeny na testovací aplikaci. Data z testů jsou zprostředkovány pro analýzu a vyhodnocení. Aplikace je nasazena v kontejnerizovaném prostředí a vytvořena s ohledem na rozšiřitelnost pro otestování konkrétní doménové problematiky.

\n{2}{Požadavky na SW}

Na aplikaci jsou pro splnění účelu analýzy vývoje, výstupu a výkonu služeb kladeny přímé i nepřímé požadavky. Je klíčové navrhnout řešení, vybrat technologie a provést implementaci včetně konfigurace s ohledem na tyto požadavky. Následující sekce je kategorizována do funkčních a nefunkčních požadavků.

\n{3}{Funkční požadavky}

Funkční požadavky definují chování, funkce a vlastnosti, které musí systém poskytovat. Přímo souvisejí s doménovými požadavky a zahrnují specifikace, jako je zpracování dat, provádění výpočtů nebo podpora konkrétních procesů. Funkční požadavky popisují očekávané operace systému, včetně vstupů, chování a výstupů. Jsou tak klíčové pro vývoj a testování. Následující seznam funkčních požadavků byl definován pro testovací aplikaci.

\begin{itemize}
  \item \textbf{Healthchecks} - Služby musí implementovat na REST API healtcheck endpoint, který bude poskytovat informace o stavu služby. Endpoint musí být dostupný na standardní adrese \emph{/health}. Návratová hodnota bude triviálně formou řetězce \emph{Healthy} a vracet HTTP Code 200 v případě, že je služba dostupná. Dostupnost je definována schopností služby přijímat požadavky.
  \item \textbf{SwaggerUI} - Pro vizualizaci a testování REST API služeb musí být implementováno grafické rozhraní SwaggerUI. SwaggerUI musí být dostupné na standardní adrese \emph{/swagger} a musí zobrazovat dostupné endpointy a umožňovat jejich testování. Konfigurace implementující SwaggerUI je pouze JIT kompilace a režim Debug.
  \item \textbf{Persistence souborů} - Aplikace musí umožňovat ukládání libovolného souboru do persistentního úložiště. Soubor musí být uložen do PostgreSQL databáze a musí být možné ho následně stáhnout. Pro ukládání a čtení souborů musí být implementováno skrz REST API. Specificky pro čtení souborů musí být implementováno i gRPC rozhraní.
  \item \textbf{Generování signálů} - Aplikace musí být schopna generovat náhodné signály. Signál musí obsahovat název, jednotku a hodnotu. Pro získání generovaných signálů musí být implementováno přes REST API.
  \item \textbf{Výpočet n-tého Fibonacciho čísla} - Je požadováno, aby aplikace poskytovala funkcionalitu výpočtu Fibonacciho čísla rekurzivní metodou. Tato neefektivní metoda má za účel vytvořit zátěž na systém. Pro volání výpoču a získání výsledku musí být implementováno pomocí REST API.
  \item \textbf{Asynchronní komunikace} - Aplikace musí být schopna asynchronně zpracovávat data z jiných služeb. To zahrnuje vyvolání události a její následnou konzumaci vzorem publish - subscribe. Pro implementaci asynchronní komunikace bude využito RabbitMQ. Samotné vyvolání události musí být k dispozici pomocí požadavku na REST API.
  \item \textbf{Sběr telemetrických dat z .NET služeb} - Aplikace musí být schopna sbírat a ukládat telemetrická data z .NET služeb. To zahrnuje metriky, logy a traces. Data musí být dostupná v reálném čase. Veškerá data budou strukturována dle zásad OpenTelemetry a sbírány na gRPC rozhraní této služby. Sbíraná data budou určena podstatou funkcionality služby a doplněna o množinu dostupných a relevantních metrik zprostředkovaných implementacemi knihoven OpenTelemetry.
  \item \textbf{Monitorování kontejnerů a systému} - Aplikace musí být schopna sbírat a vizualizovat data o výkonu, škálovatelnosti kontejnerů a hostitelského systému. To zahrnuje sběr a vizualizaci výkonnostních metrik. Data musí být dostupná v reálném čase a musí být persistentně ukládána.
  \item \textbf{Testování scénářů} - Aplikace musí být schopna provádět testování scénářů, které simulují fungování systému a zátěž na mikroslužby. Testovací scénáře musí jednoduše vytvořitelné pomocí skriptů. Spouštění scénářů nad aplikací musí být možno více způsoby, napřímo pomocí nástroje nativně běžícího na hostitelském sytému, ale také kontejnerizovaným nasazením nástroje. Testovací scénáře musí být konfigurovatelné a spustitelné v manuálním a automatizovaném režimu. 
  \item \textbf{Vizualizace dat} - V rámci aplikace musí být dostupné grafické rozhraní pro vizualizaci metrik a testovacích dat. Vizualizace musí být dostupná v reálném čase a musí být možné zobrazit historická data. Je nutné, aby aplikace umožnila data seskupovat a filtrovat podle druhu, značek a času. Zároveň je požadováno, aby uživatelé mohli jednoduše připojit různé zdroje dat a vytvářet vizualizace ve vlastní režii. Přístup k nástroji musí být řešen přes webové rozhraní.
  \item \textbf{Směrování} - Přístup k aplikaci bude řešen pomocí reverzní proxy. Ta bude mít vystavené rozhraní z orchestračního nástroje a její indexovací stránka bude odkazovat na vizualizační nástroj monitorovacích dat.
  \item \textbf{Konfigurace aplikace} - V rámci aplikace musí být možnost konfigurovat chování nasazených služeb. To se týká jak konfigurace komunikace mezi službami, tak i konfigurace monitorovacích nástrojů. Konfigurace musí být uložena v konfiguračních souborech ve standardním formátu dle konvencí dané služby nebo nástroje.
\end{itemize}

\n{3}{Nefunkční požadavky}

Nefunkční požadavky specifikují celkové vlastnosti systému. Definují atributy kvality, které musí systém splňovat. Nefunkční požadavky mohou zahrnovat omezení týkající se návrhu a implementace aplikace, jako jsou bezpečnostní standardy, soulad s právními a regulačními směrnicemi, doba odezvy při zpracování dat, kapacita pro souběžné uživatele, integrita dat a mechanismy převzetí služeb při selhání. Mají zásadní význam pro zajištění životaschopnosti a efektivity aplikace v provozním prostředí. Ovlivňují celkový uživatelský dojem, výkonnost systému a splnění regulačních podmínek.

\begin{itemize}
  \item \textbf{Použitelnost} - Aplikace musí být snadno použitelná a přístupná pro uživatele. To zahrnuje snadnou konfiguraci a nasazení aplikace na specifickém HW a OS. Aplikace musí být snadno dostupná na webovém rozhraní a standardních portech.
  \item \textbf{Udržitelnost} - Aplikace musí být udržitelná a snadno rozšiřitelná. To zahrnuje dodržení praktik čistého kódu a vhodných návrhových vzorů. Implementace služeb musí být založena na principu SOLID a Don't Repeat Yourself (dále DRY). Dodržování SOLID principu zajišťuje testovatelnost, rozšiřitelnost a dlouhodobou udržitelnost aplikace. Zatímco použitím DRY principu zabráňuje duplicitě kódu. Vytvořený kód, konfigurace a skripty musí být řádně dokumentovány.
  \item \textbf{Testovatelnost} - Aplikace musí být snadno testovatelná. To zahrnuje zprostředkování nástrojů a API pro možnost definice a konfigurace vlastních testovacích scénářů. Testování musí být automatizovatelné s výstupem persistentně ukládaným a zprostředkovaným do monitorovacíh nástrojů.
  \item \textbf{Přívětivost} - Aplikace musí být přívětivá pro uživatele. To zahrnuje snadnou navigaci, přehlednost a intuitivní ovládání. Vizuální stránka aplikace musí být jasná a přehledná.
\end{itemize}

\n{2}{Požadavky na HW}

Hardware, na kterém bude aplikace provozována, musí výkonnostně dostačovat pro provozování testovacích scénářů a sběr a vizualizaci dat. Týká se to primárně počtu jader, velikosti paměti a rychlosti diskového I/O. Provozované služby mají určitou základní režii, která se musí brát v potaz.

\n{2}{Organizace a správa zdrojů}

Pro správu souborů práce byl zvolen verzovací systém (Source Control Management, dále SCM) Git. Git je open-source nástroj, který umožňuje spravovat a sdílet soubory. Git byl zvolen pro svou schopnost pracovat s větvemi a s ohledem na dostupná úložiště. Za účelem jednoduché organizace souborů bylo zvoleno řešení monorepozitáře. Monorepozitář je repozitář, který obsahuje veškeré soubory projektu, ale také relevantní dokumentaci, obrázky, podpůrné nástroj a zdrojové soubory diplomové práce. Následující struktura adresářů byla zvolena pro organizaci souborů.

\begin{itemize}
    \item \textbf{Documentation} - adresář obsahující dokumentaci aplikace.
    \item \textbf{Source} - adresář obsahující zdrojové soubory aplikace.
    \item \textbf{Thesis} - adresář obsahující zdrojové soubory textu diplomové práce a práci samotnou ve formátu pdf.
\end{itemize}

Pro zaručení dostupnosti a sdílení veškerých prostředků souvisejících s prací byl vybrán GitHub, jakožto server pro hostování repozitáře. GitHub je open-source platforma pro verzování souborů a projektů. Navíc poskytuje rozšířující možnosti jako je CI/CD, správa dokumentace a další. Repozitář projektu je veden jako veřejný s licencí MIT. Repozitář je dostupný na adrese \url{https://github.com/DonasNave/MasterThesis}.

\n{2}{Návrh a implementace testovacích služeb}

Následující pasáž se zabírá návrhem a implementací testovacích služeb, které budou využity pro analýzu vývoje a výkonu jednotlivých kompilací AOT a JIT v rámci .NET. Služby jsou implementovány jako mikroslužby a podporují kontejnerizované nasazení v microservice architektuře. Každá služba reprezentuje jednu dílčí funkcionalitu a má definované rozhraní pro komunikaci s ostatními službami. Pro implementaci služeb byla vybrána z podstaty práce technologie .NET, konkrétně jazyk C\#. Verze frameworku byla zvola .NET 8.0 jakožto jediná verze oficiálně podporující nativní AOT kompilaci pro framework ASP.NET.

\n{3}{Architektura}

Pro implementaci požadované funkcionality bylo zvoleno následující rozdělení zodpovědnosti služeb:

\begin{itemize}
    \item \textbf{SRS - Signal reading service} - Služba simuluje roli čtecího zařízení. Generuje data a poskytuje je ostatním službám. Poskytuje REST API rozhraní.
    \item \textbf{FUS - File Upload Service} - Zprostředkovává datové persistentní zapisovací zařízení. Čte nebo zapisuje data do PostgreSQL databáze. Poskytuje REST API a gRPC rozhraní.
    \item \textbf{BPS - Batch Processing Service} - Služba, která zpracovává data z jiných služeb. Reaguje na požadavek o hromadném zpracování při předem definovaném splnění podmínek. Poskytuje REST API a gRPC rozhraní. Je přihlášena do RabbitMQ jako subscriber.
    \item \textbf{EPS - Event Publishing Service} - Slouží k vyvolání události, která je následně zpracována jinými službami. Poskytuje REST API rozhraní. Je přihlášena do RabbitMQ jako publisher.
\end{itemize}

Kompilace do nativního AOT kódu je deklarována použitím atributu PublishAoT v projektovém souboru. Za účelem zajištění co největší podobnosti služeb zacílených na AOT a JIT kompilaci, bude využito zadefinování konstantních hodnot v rámci projektu. Konstanty \emph{JIT} a \emph{AOT} budou využity pro rozlišení chování služeb v rámci obou kompilačních verzí. S použitím direktiv kompilátoru a zmíněných konstant bude v nutných případech docíleno rozdílného volání API při snaze zachovat totožnou funkcionalitu.

\n{3}{Očekávání vývojového procesu}

Na základě podporované funkcionality, tak jak je definována týmem .NET a popsána v rámci rešerše, je očekáváno, že vývojový proces bude probíhat bez výrazných problémů a bude možné vytvořit služby, které budou schopny zvládnout definované funkční a nefunkční požadavky. Podpora třetích stran byla předem prozkoumána v rámci dostupných dokumentací vybraných knihoven .NET. Konkrétní podoba a rozsah této podpory bude plně ověřitelná až po implementaci a otestování služeb.

\n{3}{Organizace souborů}

Organizace zdrojových souborů služeb, knihoven a pomocných souborů je řešena v rámci hlavního adresáře \emph{DTA} obsahujícího .NET solution soubor, pomocné soubory a solution složky s konkrétními projekty služeb a knihoven. Následující stromový graf představuje adresářovou strukturu projektu.

\obr{Stromová struktura projektu}{fig:projectstructure}{0.3}{graphics/images/folder-structure-app.png}

Každá z vyvinutých služeb využívá konkrétní .NET SDK \emph{Microsoft.NET.Sdk.Web}, které umožňuje využít třídu \emph{WebApplication} pro registraci a konfiguraci funkcionality služby a zároveň poskytuje konfigurovatelný Kestrel server pro běh programu. Za účelem zajištění jednotného přístupu k logování, metrikám a konfiguraci byly vytvořeny společné knihovny, které jsou využity ve všech službách.

\obr{Stromová struktura služby}{fig:servicestructure}{0.3}{graphics/images/folder-structure-service.png}

\begin{itemize}
  \item \textbf{Api} - Obsahuje implementaci rozhraní služby.
  \item \textbf{Extensions} - Implementuje extension metody specifické pro doménu služby.
  \item \textbf{Monitoring} - Obsahuje statickou třídu, která drží reference na počítadla metrik.
  \item \textbf{Service} - Ve složce jsou implementovány služby, které provádějí doménovou logiku služby.
  \item \textbf{Properties} - Drží konfiguraci pro spuštění služby.
  \item \textbf{Program.cs} - Obsahuje definici a konfiguraci služby, včetně jejího vstupního bodu.
  \item \textbf{appsettings.json} - konfigurace služby.
  \item \textbf{Dockerfile-AOT} - Soubor pro tvorbu Docker obrazu pro AOT kompilaci.
  \item \textbf{Dockerfile-JIT} - Soubor pro tvorbu Docker obrazu pro JIT kompilaci.
\end{itemize}

Součástí řešení je společná konfigurace, která je využita ve všech službách. Ta je řešena jedna na úrovni solution souboru, tak i Directory.Build.props souboru. Týká se jednotné distribuce projektových atributů pro verzi, kompatibilitu s AOT, vynucení konkrétních pravidel pro kód a analyzéry.

\n{3}{Knihovny třetích stran}

Pro implementaci funkcionality aplikace byly využity následující knihovny třetích stran:

\begin{itemize}
  \item \textbf{Npgsql} - Npgsql je open-source ADO.NET provider pro PostgreSQL, který umožňuje komunikaci s PostgreSQL databází. Npgsql poskytuje základní balíček funkcí pro vytvoření připojení na základě standardizovaného řetězce pro připojení. Tento balíček sice není plně kompatibilní s AOT kompilací, funkce které jsou využity v rámci aplikace jsou avšak kompatibilní.
  \item \textbf{Dapper} - ORM knihovna pro .NET, která umožňuje mapovat databázové struktury na C\# objekty a vytvářet a provádět dotazy na databázi. \emph{Dapper.AOT} je dílčí knihovna, která umožňuje vytvářet a provádět dotazy na databázi v rámci AOT kompilace. Toho je zajištěno tím, že Dapper.AOT generuje kód pro dotazy na databázi v době kompilace. Využívá k tomu interceptorů a generátorů. Samotný balíček Dapper.AOT obsahuje další knihovnu - \emph{Dapper.Advisor}, která pomáhá s analýzou zdrojového kódu a generováním kódu pro dotazy na databázi.
  \item \textbf{OpenTelemetry} - OpenTelemetry zprostředkovává množinu knihoven pro sběr, zpracování a export telemetrických dat. V rámci knihovny je umožněno registrace vlastních metrik, logů a traces, ale také nastavení exportu vybraných systémových dat sbíraných v rámci knihoven .NET.
  \item \textbf{Grpc} - Knihovny pro implementaci komunikace pomocí protokolu HTTP/2 a gRPC. Konkrétně jsou využity \emph{Grpc.AspNetCore} v případě serveru, \\ \emph{Grpc.Net.Client} pro klienta a \emph{Google.Protobuf} s \emph{Grpc.Tools} pro generování modelů v přístupu model first.
  \item \textbf{RabbitMQ} - Komunikace a implementace publish subscribe vzoru je umožněna knihovnou \emph{RabbitMQ.Client}. S její pomocí jsou vytvářeny fronty, dochází k přihlášení k odběru zpráv a jejich publikování.
  \item \textbf{Swagger} - Grafické rozhraní pro vizualizaci a testování REST API služeb. Swagger je využit pouze v kombinaci konfigurací \emph{JIT Debug}. K tomuto účelou jsou využity knihovny \emph{Swashbuckle.AspNetCore} a \emph{Microsoft.AspNetCore.OpenApi}.
\end{itemize}

\n{3}{Společné knihovny}

V rámci zjednodušení tvorby služeb, jednotné implementace a konfigurace, ale také z důvodu zajištění některé základní klíčové funkcionality, byly vytvořeny společné knihovny. Tyto knihovny obsahují společné třídy, rozhraní a konfigurace, které jsou použity ve všech službách.

\begin{itemize}
  \item \textbf{Persistence} - Pro implementaci persistence byla vytvořena pomocná knihovna \\ \emph{DTA.Extensions.Postgres}, která poskytuje pomocnou funkcionalitu pro zajištění existence databáze pro službu, dle konfigurace v řetězci pro připojení.
  \item \textbf{Migrace} - Zajištění migrace databáze bylo implementováno po vlastní ose minimalistickým migrátorem v knihovně \emph{DTA.Migrator}. Tato knihovna poskytuje základní funkcionalitu pro vytvoření databáze, vytvoření tabulek a indexů, ale také zajištění migrace dat a verzování změn.
  \item \textbf{Telemetrie} - Knihovna \emph{DTA.Extensions.Telemetry} zprostředkovává extensions metody pro jednotnou a jednoduchou registraci sběru a export telemetrických dat napříč službami.
  \item \textbf{Modely} - Knihovna \emph{DTA.Models} obsahuje společné modely, které jsou využity ve službách. Je tím docílena viditelnost na datové struktury rozhraní aplikace napříč všemi službami, jež knihovnu referencují.
  \item \textbf{Obecná funkcionalita} - Za účelem sjednocení funkcionality využité napříč všemi službami jsou implementovány extension metody v knihovně \\ \emph{DTA.Extensions.Common}. Zde je poskytnuta funkcionalita pro sestavení názvů pro službu.
\end{itemize}

\n{3}{SRS - Signal reading service}

Za účelem simulace funkce čtecího zařízení byla vytvořena služba SRS. Tato služba poskytuje základní rozhraní pro získání dat signálu včetně jednotek a značek formou REST API. Pro zjednodušení implementace není využito čtení dat ze skutečného zdroje, ale jsou generována náhodná data. Načež data jsou následně poskytována se zdržením simulujícím čtení dat ze vzdáleného zdroje.

Služba poskytuje následující rozhraní

\begin{itemize}
    \item \textbf{GET /api/signals/\{int:amount\}} - Vygeneruje zadané množství náhodných signálů
\end{itemize}

\n{3}{FUS - File Upload Service}

Služba v systému hraje roli zapisovacího zařízení, které zapisuje a čte data z perzistentního úložiště. Jakožto úložiště je využito PostgreSQL databáze. Služba využívá vlastní databázovou instanci a spravuje vlastní tabulky pomocí migrací definovaných SQL skripty. Pro přístup k persistence dat je využito knihovny knihovny Dapper, která umožňuje mapování databázových struktur na C\# objekty a vytváření a provádění dotazů na databázi. SRS poskytuje rozhraní formou REST API pro zápis a čtení dat. Daty je myšlen libovolný soubor v libovolném formátu. Samotná podstata nahraných dat není pro službu důležitá, ale to že jsou uložena do databáze. Za účelem sehrání testovacích scénářů poskytuje služba také gRPC rozhraní, které je zajištěno na dedikovaném portu. V rámci gRPC komunikace slouží služba jako server, který splňuje volání vzdálené procudery. Služba poskytuje následující rozhraní:

\begin{itemize}
    \item \textbf{GET /api/file/download/\{int:id\}} - Stáhne soubor podle zadaného ID.
    \item \textbf{POST /api/file/upload} - Nahraje soubor do systému.
    \item \textbf{gRPC Operation FileServer.GetFile} - Stáhne soubor podle zadaného objektu s ID.
\end{itemize}

\n{3}{BPS - Business Processing Service}

Pro splnění role a požadavků na zpracování dat z jiných služeb byla vytvořena služba BPS. Tato služba získává data, provádí náročné výpočetní operace, sloužící k simulaci obtížných doménových operací. Konkrétně implementaváno je neefiktivní rekurzivní výpočet Fibonacciho posloupnosti. Služba se po spuštění přihlašuje k odběru zpráv na předem definovaný kanál \emph{simulated} na službe \emph{RabbitMQ}. Po získání zprávy získává data ze služby FUS pomocí volání vzdálené procedury. Po získání dat provádí náročné výpočetní operace, které jsou simulovány náhodným čekáním. Služba poskytuje následující rozhraní:

\begin{itemize}
    \item \textbf{GET /api/processFibonacci/\{int:degree\}} - Vypočítá číslo z Fibonacciho posloupnosti na zadané pozici náročným rekurzivním způsobem.
    \item \textbf{Event subscribed: \{queue-name\}\_simulated} - Přihlášení k odběru zpráv v rámci kanálu na službě RabbitMQ.
\end{itemize}

\n{3}{EPS - Event Publishing Service}

Jednoduchá službami umožňující vyvolat událost v systému a docílit spuštění dodatečných operací v systému. V systému simuluje roli vydavatele událostí Poskytuje REST API rozhraní pro vyvolání události. Po vyvolání události je zpráva publikována do RabbitMQ kanálu, kde je zpracována jinými službami. Služba poskytuje následující rozhraní:

\begin{itemize}
    \item \textbf{GET api/simulateEvent/\{int:id\}} - Vyvolá simulovanou událost s daným ID.
    \item \textbf{Event published: \{queue-name\}\_simulated} - Vyvolá údalost se zprávou obsahující identifikator na konfigurovaném kanálu do služby RabbitMQ.
\end{itemize}

Následující diagram znázorňuje přímé závislosti testovacích služeb na další nástroje.

\obr{Diagram .NET služeb a závislých služeb}{fig:logo}{0.75}{graphics/diagrams/services-architecture.png}

\n{2}{Monitorování aplikace}

Za účelem monitorování systému byla vybraná množina nástrojů. Tyto nástroje umožňují sběr, uchování a vizualizaci metrik a logů. Klíčové bylo zajistit možnost sledovat dění uvnitř aplikace, ale i v rámci hostitelského systému. 

\n{3}{Grafana observability stack}

Pro monitorování aplikace byl zvolen Grafana Observability stack pro jeho pokrytí komplexní škály monitorovacích dat. Zahrnuje nástroje pro sběr, vizualizaci a analýzu dat. Poskytuje jednoduchou možnost propojení dílčích nástrojů a konfiguraci datových zdrojů. V neposlední řadě poskytuje rozsáhlé možnosti vizualizace. Následující nástroje jsou součástí Grafana Observability stacku:

\begin{itemize}
  \item \textbf{Grafana} - Grafana je open source webová aplikace pro analýzu a interaktivní vizualizaci dat. Poskytuje možnost sestavit dashboard z komponent jako jsou grafy, tabulky a další. Jedná se o velmi populární technologii v doménách serverové infrastruktury a monitorování. Grafana umožňuje sjednotit monitorovací služby a zobrazit data v reálném čase. Podporuje širokou škálu datových zdrojů, jako jsou Prometheus, InfluxDB, Tempo, Loki nebo PostgreSQL, což umožňuje jednoduchou konfiguraci a připojení monitorovacích dat aplikace. Zároveň nativně podporuje datový zdroj, kde ukládá data testovací nástroj aplikace. Kombinací dat z různých zdrojů umožňuje vytvářet komplexní pohled na celý systém.
  \item \textbf{Prometheus} - Open-source monitorovací systém. Shromažďuje a ukládá metriky jako time-series data a umožňuje se na ně dotazovat pomocí vlastního výkonného jazyka PromQL. Jeho architektura podporuje více modelů získávání dat, stahování metrik z cílových služeb nebo kolektorů, odesílání metrik přes gateway a zprostředkování notifikací.
  \item \textbf{Loki} - Škálovatelný agregátor logů. Na rozdíl od obdobných systémů pro agregaci logů, jenž indexují všechna data, Loki indexuje pouze metadata, přičemž ukládá celá data logu efektivním způsobem. Loki je navržen tak, aby jednoduše spolupracoval s Grafanou a umožňuje rychle vyhledávat a vizualizovat logy.
  \item \textbf{Tempo} - Poskytuje jednoduše ovladatelný open-source nástroj pro distribuované sledování požadavků. Tempo podporuje ukládání a načítání traces. Na rozdíl od mnoha jiných nástrojů pro traces nevyžaduje Tempo žadné předem definované schéma. Je navržen tak, aby se bezproblémově integroval s Prometheus, Loki a aby jednoduše přijímal data z OpenTelemetry.
  \item \textbf{OpenTelemetry} - Open source kolektor telemetrických dat. Poskytuje jednotný, vendor-agnostic způsob sběru, zpracování a exportu telemetrických dat  Je konfigurovatelný a podporuje více pipeline, které mohou upravovat telemetrická data při jejich průchodu. Výrazně zjednodušuje instrumentaci služeb, protože umožňuje agregovat a exportovat metriky, traces a logy do různých analytických a monitorovacích nástrojů. Poskytuje podporu pro export dat do Prometheus, Tempo i Loki.
\end{itemize}

Implementace Grafana Observability stacku je zajištěna pomocí obrazu nazvaného dta-lgtm a sestrojeného po vzoru Grafana LGTM (Loki, Grafana, Tempo a Mimir). Grafana LGTM kombinuje množinu monitorovacích nástrojů v rámci jediného obrazu s předchystanou konfigurací. Tím je odstíněna část konfigurace monitorovacího stacku a zjednodušen proces nasazení. Obraz použitý v rámci práce využívá kombinaci dříve zmíněných technologií (Loki, Tempo, Grafana, Prometheus a OpenTelemetry) zabalených a předkonfigurovaných v rámci Docker obrazu. Tím je v aplikaci zajištěno, že potřebná konfigurace pro vzájemné propojení nástrojů a datových zdrojů je předpřipravena. Stejně tak jsou součástí vytvořeného obrazu vlastní monitorovací dashboardy pro vizualizace.

V rámci aplikace mají jednotlivé služby nastaven export svých logů, traces a metrik do OpenTelemetry, respektive na adekvátní rozhraní dta-lgtm. Služby využívají existujících metrů a logů, ale také vytváří vlastní metriky a logy. Vlastní metriky zahrnují informace o počtu a druhu provedených operací. Z předpřipravených metrik, ať systémových nebo třetích strán jsou využity následující instrumentace:

\begin{itemize}
  \item \textbf{System.Runtime} - Metriky běhového prostředí .NET.
  \item \textbf{System.Net.Http} - Metriky HTTP dotazů.
  \item \textbf{Microsoft.AspNetCore.Hosting} - Metriky hostovacího prostředí ASP.NET Core.
  \item \textbf{Microsoft.AspNetCore.Server.Kestrel} - Metriky serveru Kestrel.
  \item \textbf{Npgsql} - Metriky klientské knihovny PostgreSQL.
\end{itemize}

\n{3}{Monitorování hostitelského systému}

Monitorování hostitelského systému poskytuje pro aplikaci klíčové informace o využití zdrojů a výkonu, jak ze samotnéhé systému, tak i z jednotlivých kontejnerů. Pro monitorování Docker kontejnerů je využit nástroj CAdvisor. CAdvisor je schopen monitorovat kontejnery běžící na Dockeru, Kubernetes nebo jiných kontejnerových platformách. Poskytuje informace o využití procesoru, paměti, sítě a diskového I/O z pohledu hostitelského systému. Dalším využitým nástrojem je NodeExporter. NodeExporter je nástroj pro sběr metrik z hostitelského systému. Obdobně jako CAdvisor poskytuje informace o využití procesoru, paměti, sítě a diskového I/O.

\n{2}{Testovací nástroje}

Za účelem testování monitorovacího stacku byl vybrán nástroj K6. Jedná se o moderní open-source nástroj pro zátěžové testování. Slouží k vytváření, provádění a analýze výkonnostních testů softwarových aplikací. Nabízí jednoduché skriptovací rozhraní v jazyce JavaScript. Umožňuje psát komplexní testovací scénáře napodobující reálný provoz systému, nebo simulovat hraniční situace. K6 podporuje různé systémové metriky, jako je doba odezvy, propustnost a chybovost. Nabízí šiřoké možnosti rozšíření skrze API, což umožňuje přizpůsobení a integraci s dalšími nástroji pro komplexní sledování výkonu. Pro zjednodušení procesu testování a zajištění opakovatelnosti testovacích scénářů byly vytvořeny skripty pro spuštění testů. Tyto skripty zajišťují opakovatelné spouštění testů v rámci Docker kontejneru s nastavitelnými parametry. Skripty jsou vytvořeny v jazyce Bash a využívají nástroje K6 pro spuštění testů a zpracování výsledků.

\n{2}{Nasazení aplikace}

Následující pasáž popisuje náležitosti nasazení aplikace, včetně obecného popisu finální struktury nasazení, využitých nástrojů kontejnerizace a orchestrace, konkrétních verzí obrazů a použitou konfiguraci.

\n{3}{Přehled řešení}

Řešení aplikace sestává z následujících sekcí a jednotlivých obrazů služeb a verzí, definovaných v rámci Docker Compose souboru.

\begin{itemize}
    \item \textbf{Testovací služby} - Aplikace obsahuje testovací .NET služby FUS, SRS, BPS a EPS. Tyto služby jsou vytvořeny ve dvou kompilačních verzích - AOT a JIT. Každá služba je vytvořena jako obraz s názvem \emph{dta-<service-name>} a značkou \emph{<compilatioinMode>-latest}.
    \item \textbf{Komunikace} - Komunikační kanál mezi službami je zajištěn pomocí RabbitMQ. Pro RabbitMQ je využit obraz \emph{rabbitmq:3-management-alpine}.
    \item \textbf{Monitorovací nástroje} - Monitorování zajišťuje Grafana Observability stack implementovaný v rámci obrazu \emph{dta-lgtm:latest}, jenž obsahuje OpenTelemetry, Prometheus, Loki, Tempo a Grafanu. Pro měření výkonu hostitelského systému a export těchto dat jsou využity služby NodeExporter a CAdvisor s obrazy \emph{node-exporter:latest} a \emph{cadvisor-arm64:v0.49.1}.
    \item \textbf{Persistence} - Pro persistenci dat je využita PostgreSQL databáze. Pro PostgreSQL je využit obraz \emph{postgres:latest}. Ukládání metrik je zajištěno pomocí InfluxDB a obrazu \emph{influxdb:1.8.10}.
    \item \textbf{Směrování} - Funkci reverzní proxy zajišťuje Nginx ve verzi obrazu \emph{nginx:latest}.
\end{itemize}

\obr{Diagram nasazení aplikace}{fig:app}{0.85}{graphics/images/dta.drawio.png}

\n{3}{Kontejnerizace a orchestrace}

Kontejnerizace služeb je zajištěna pomocí nástroje Docker. Docker je open-source platforma poskytující ekosystém pro správu kontejnerů. Jednotlivé služby jsou vytvořeny jako obrazy podle definicí Dockerfile. 

Orchestrace aplikace je zprostředkována rovněž nástrojem Docker, konkrétně formou \emph{compose} utility. Ta umožňuje jednoduše nasadit a spravovat větší množství služeb. Definice nasazení aplikace je sepsána v souboru \emph{compose.yaml}. V něm lze nalézt následující části:

\begin{itemize}
  \item \textbf{volumes} - V této sekci jsou definovány všechny volume, které jsou využity v rámci stacku. Volume jsou definovány názvem a využity pro ukládání dat služeb. Konkrétně jsou využity úložiště pro data Grafany, OpenTelemetry, Prometheus a InfluxDB.
  \item \textbf{networks} - Konfigurace pro vnitřní síť aplikace, která je využita pro komunikaci mezi službami. Síť je definována názvem a typem. Pro potřeby aplikace se využívá síť s názvem \emph{stack-network} a typ \emph{bridge}, jenž funguje jako síťový most.
  \item \textbf{services} - Definuji sekci pro jednotlivé služby, které jsou součástí stacku. Každá služba je definována názvem služby - \emph{container\_name}, názvem obrazu - \emph{image}, v případě lokálně sestavených služeb také definicí sestavení - \emph{build}. Dále je definováno, jaké porty jsou mapovány z kontejneru do hostitelského systému - \emph{ports}, jaké volume jsou připojeny k kontejneru - \emph{volumes}, použité síťové rozhraní - \emph{networks}, závislosti služby - \emph{depends\_on} a proměnné prostředí - \emph{environment}. V případech testovaných služeb je uvedena dodatečná konfigurační sekce nasazení - \emph{deploy}, jenž limituje dostupné zdroje paměti a procesoru.
\end{itemize}

\n{3}{Konfigurace nasazení}

Za účelem běhu aplikace je klíčové správné nastavení konfigurace. Konfigurace je řešena na různých úrovních. Základní úroveň představuje soubor \emph{compose.yaml}.  Dále jsou v tomto souboru nastaveny základní parametry jako je jméno sítě, názvy volume (persistentní úložiště orchestrátoru), závislosti mezi službami a další. V neposlední řadě je dílčí konfigurace jednotlivých služeb řešena v rámci konfiguračních souborů a proměnných prostředí. 

Nastavení směrování v rámci stacku je řešeno konfigurací proxy služby Nginx. Za tímto účelem obsahuje dva klíčové soubory, rozcestník v podobně statického index.html souboru a konfigurační nginx.conf soubor se směrovacími pravidly. Oba zmíněné soubory jsou do služby připojeny formou mapování virualizovaného repozitáře kontejneru. Směrovací pravidla jsou následující:

\begin{itemize}
    \item / - cesta na statickou hlavní stránku-rozcestník aplikace
    \item /grafana - směrování na Grafanu
\end{itemize}

Nastavení telemetrie spočívá v definici rozhraní, nastavení chování služeb a systémů z niž se telemetrická data sbírají, jejich cíl pro zpracování, správu a vizualizaci. Značnou část konfigurace představuje propojení nástrojů stacku LGTM, k čemuž slouží konfigurační soubory. Ty obsahují výchozí minimalistickou konfiguraci pro jednotlivé nástroje. Výstupem LGTM je individuální kontejner a zmíněná konfigurace je náturou interní a není potřeba s ní manipulovat s ohledem na požadavky práce uživateli. Mezi dodatečné konfigurace telemetrie napříč službami patří:

\begin{itemize}
    \item \textbf{Testované služby} - Veškeré testovací služby mají nastavený endpoint pro export telemetrických dat. Toto nastavení je zprostředkováno proměnnou prostředí \emph{OpenTelemetrySettings\_ExporterEndpoint}.
    \item \textbf{LGTM} - Konfigurace pro LGTM je řešena pomocí proměnných prostředí. Je definována adresa a cesta, z které je k dispozici Grafana. Dále je umožněno anonymní přihlášení do Grafany.
    \item \textbf{Cadvisor} - Nastavení služby představuje dodatečné nastavení volumes, které jsou připojeny k kontejneru. Připojením systémových souborů je zajištěno sběr dat o využití systémových zdrojů. Toto nastavení je závislé na operačním systému.
\end{itemize}

Jednotlivé služby mají vlastní dodatečné konfigurace, které jsou řešeny pomocí kombinace dle standardizovaného postupu pro konfiguraci .NET aplikací, a to konfiguračního souboru \emph{appsettings.json} a proměnných prostředí. V první řadě řadě je použita konfigurace ze souboru, načež je přepsána odpovídajícími hodnotami proměnných prostředí. Každá služba má definovaný specifický prefix pro identifikaci proměnných prostředí. Následující seznam popisuje dodatečné konfigurace jednotlivých služeb.

\begin{itemize}
  \item \textbf{FUS - File Upload Service} - Obsahuje connection string (přístupový řetězec) pro připojení do databáze PostgreSQL.
  \item \textbf{BPS - Batch Processing Service} - Disponuje konfigurací pro připojení k RabbitMQ a konkrétní frontě.
  \item \textbf{EPS - Event Publishing Service} - Drží informaci o rozhraní RabbitMQ, konkrétní frontě a gRPC rozhraní služby FUS.
\end{itemize}

Služby využité pro perzistentní ukládání dat jsou konfigurovány pomocí proměnných prostředí. Jedná se o následující služby:

\begin{itemize}
  \item \textbf{PostgreSQL} - Jsou definovány údaje pro uživatele databáze a název databáze.
  \item \textbf{InfluxDB} - Proměnné prostředí definují název databáze, uživatelské údaje a povolení přihlášení pomocí http.
\end{itemize}

Definice uživatelského rozhraní, respektive dostupných dashboardů, je dána při sestavení obrazu LGTM. V rámci něj jsou předdefinovány hodnoty pro připojení zdrojů dat, tj. Prometheus, Loki, Tempo a InfluxDb. Patřičné dashboardy zobrazující relevantní data pro různé scénáře systému byly předem připraveny a jsou k dispozici po otevření Grafany anonymním uživatelem. Následující seznam popisuje klíčové soubory konfigurace uživatelského rozhraní.

\begin{itemize}
  \item \textbf{grafana-dashboards.json} - Definuje dostupné dashboardy v Grafaně. Dashboardy jsou definovány v JSON formátu a obsahují definici panelů, zdrojů dat a dalších parametrů.
  \item \textbf{grafana-datasources.json} - Obsahuje  zdroje dat z kterých Grafana, respektive dashboardy, čerpají data.
\end{itemize}